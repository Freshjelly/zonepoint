# FX YouTube チャンネル競合分析ツール（堅牢版）運用ガイド

## 🎯 概要

この堅牢版は、YouTube Data API v3のクォータ制限を超えることなく安定稼働するように設計されたFXチャンネル分析ツールです。

### 主な改善点
- **クォータ予算制御**: 1日9,000ユニット以内で自動制御
- **探索（週次）と更新（日次）の分離**: 効率的なリソース利用
- **バッチ処理**: 50件ずつまとめてAPI呼び出し
- **差分更新**: 新規データのみを取得
- **堅牢なエラーハンドリング**: レート制限・クォータ超過対応

## 📋 セットアップ手順

### 1. 前提条件
- Googleアカウント
- YouTube Data API v3の有効化
- Google Apps Scriptの実行権限

### 2. API設定

1. **Google Cloud Console**でプロジェクトを作成
2. **YouTube Data API v3**を有効化
3. **APIキー**を作成
4. Apps Scriptの「プロジェクトの設定」で以下を設定：
   - プロパティ: `YOUTUBE_API_KEY`
   - 値: [取得したAPIキー]

### 3. コード導入

1. Google Sheetsで新規スプレッドシートを作成
2. 「拡張機能」→「Apps Script」を開く
3. 既存コードを削除し、`analysegas_robust.gs`の内容を貼り付け
4. HTMLファイル`ai-assistant`を作成し、`ai-assistant.html`の内容を貼り付け
5. 保存後、スプレッドシートをリロード

### 4. 初期設定

1. メニュー「📋 初期設定」を実行
2. 権限の承認を行う
3. 設定シートで以下を確認：
   ```
   MAX_SEARCH_PAGES: 1          # 検索結果のページ数
   MAX_SEARCH_KEYWORDS: 12      # 使用するキーワード数
   MIN_SUBSCRIBER_COUNT: 1000   # 最小登録者数
   DAYS_ACTIVE_THRESHOLD: 180   # 活動判定日数
   ```

## 🚀 運用方法

### 自動運用（推奨）

1. **トリガー設定**
   ```
   メニュー → 管理 → トリガー設定
   ```
   - 週次探索: 毎週月曜 6:10
   - 日次更新: 毎日 6:30

2. **実行確認**
   - 「クォータ管理」シートで使用状況を確認
   - 「実行ログ」シートでエラーを監視

### 手動実行

1. **自動適応実行**（推奨）
   ```
   メニュー → 🚀 今すぐ 全自動実行
   ```
   - クォータに応じて最適な処理を選択

2. **個別実行**
   - 探索のみ: `探索のみ（週次推奨）`
   - 更新のみ: `更新のみ（日次推奨）`

## ⚙️ 設定項目一覧

### コード定数（CONFIG）

| 項目 | 値 | 説明 |
|-----|---|------|
| DRY_RUN | false | true: API呼び出しをスキップ |
| FORCE_LOW_BUDGET | false | true: 残量200で動作確認 |
| DEBUG_MODE | false | true: 詳細ログ出力 |

### クォータ設定（QUOTA）

| 項目 | 値 | 説明 |
|-----|---|------|
| DAILY_BUDGET_UNITS | 9000 | 1日の上限 |
| RUN_BUDGET_UNITS | 2500 | 1回の実行上限 |
| SEARCH_UNIT_COST | 100 | 検索API のコスト |
| CHANNELS_UNIT_COST | 1 | チャンネルAPI のコスト |

### 設定シート項目

| 項目 | デフォルト値 | 説明 |
|-----|------------|------|
| MAX_SEARCH_PAGES | 1 | 検索結果の最大ページ数 |
| MAX_SEARCH_KEYWORDS | 12 | 使用するキーワード数 |
| MIN_SUBSCRIBER_COUNT | 1000 | 最小登録者数フィルタ |
| DAYS_ACTIVE_THRESHOLD | 180 | 活動判定の日数閾値 |
| ENABLE_AUTO_SEARCH | TRUE | 自動探索の有効化 |
| ENABLE_AUTO_UPDATE | TRUE | 自動更新の有効化 |

## 🧪 テスト手順

### 1. DRY_RUN テスト

```javascript
// CONFIG設定を変更
const CONFIG = {
  DRY_RUN: true,  // API呼び出しをスキップ
  // ... 他の設定
};
```

**実行手順**:
1. コードを保存
2. 「今すぐ 全自動実行」を実行
3. ログで `[DRY_RUN]` メッセージを確認
4. クォータが消費されていないことを確認

### 2. FORCE_LOW_BUDGET テスト

```javascript
const CONFIG = {
  FORCE_LOW_BUDGET: true,  // 擬似的に残量200に設定
  // ... 他の設定
};
```

**実行手順**:
1. 設定を変更して保存
2. 「今すぐ 全自動実行」を実行
3. 「クォータ不足」メッセージが表示されることを確認
4. 探索がスキップされ、更新のみ実行されることを確認

### 3. エラーハンドリングテスト

**無効なAPIキーテスト**:
1. スクリプトプロパティのAPIキーを一時的に変更
2. 実行して403エラーが適切にハンドルされることを確認
3. 実行ログにエラーが記録されることを確認

**クォータ超過テスト**:
1. `DAILY_BUDGET_UNITS`を一時的に100に設定
2. 実行してクォータ超過処理が動作することを確認

## 📊 クォータダッシュボードの見方

### 状態指標

| 項目 | 説明 | 正常範囲 |
|-----|------|--------|
| 使用量 | 当日の使用ユニット数 | < 7,200 |
| 使用率 | 使用量の割合 | < 80% |
| 残量 | 残りユニット数 | > 1,000 |
| 探索可能 | 探索実行の可否 | はい |

### アラート
- **⚠️ 警告**: 使用率80%超え
- **❌ 不可**: 探索不可能（残量500未満）

## 🔧 予算調整方法

### クォータ上限の変更

```javascript
const QUOTA = {
  DAILY_BUDGET_UNITS: 8000,  // 9000から8000に変更
  // ...
};
```

### 実行あたりの上限変更

```javascript
const QUOTA = {
  RUN_BUDGET_UNITS: 2000,    // 2500から2000に変更
  // ...
};
```

### 探索頻度の調整

**設定シートで調整**:
- `MAX_SEARCH_KEYWORDS`: 12 → 8 (検索語を減らす)
- `MAX_SEARCH_PAGES`: 1 → 1 (維持推奨)

## 🚨 トラブルシューティング

### よくある問題と対処法

#### 1. 403: quotaExceeded
**原因**: 1日のクォータ上限到達
**対処**: 
- 翌日まで待機
- `DAILY_BUDGET_UNITS`を下げる
- 探索頻度を週1回に制限

#### 2. 429: userRateLimitExceeded
**原因**: レート制限
**対処**: 
- 自動バックオフで対応済み
- `DEFAULT_DELAY_MS`を増加

#### 3. 実行時間超過
**原因**: 6分制限
**対処**:
- バッチサイズを縮小
- 対象チャンネル数を削減

#### 4. 権限エラー
**原因**: YouTube APIの権限不足
**対処**:
- Cloud Consoleで権限を確認
- APIキーの制限設定を確認

### ログの確認方法

1. **実行ログシート**
   - タイムスタンプ、API、エラー理由を記録
   - 定期的にクリアが必要

2. **Apps Scriptログ**
   ```
   Apps Scriptエディタ → 表示 → ログ
   ```

3. **クォータ使用量**
   ```
   Google Cloud Console → API → クォータ
   ```

## 📈 パフォーマンス最適化

### 効率的な運用のポイント

1. **探索頻度の最適化**
   - 新規チャンネルの発見頻度に応じて週次/月次調整

2. **対象チャンネル数の管理**
   - 競合20チャンネルに絞り込み
   - 非アクティブチャンネルの定期除去

3. **バッチサイズの調整**
   - 50件バッチを維持（API制限）
   - 必要に応じて25件に縮小

4. **差分更新の活用**
   - 新規動画のみ収集
   - 更新済みチャンネルのスキップ

## 🔄 定期メンテナンス

### 週次作業
- [ ] クォータ使用量の確認
- [ ] エラーログの確認
- [ ] 非アクティブチャンネルの除去

### 月次作業
- [ ] 検索語の見直し
- [ ] 競合チャンネルの精査
- [ ] パフォーマンス指標の確認

### 年次作業
- [ ] API制限の見直し
- [ ] 分析ロジックの改善
- [ ] 新機能の検討

## 📞 サポート情報

### 確認すべきリソース

1. **Google Cloud Console**
   - APIクォータの使用状況
   - エラー率の監視

2. **YouTube Data API ドキュメント**
   - https://developers.google.com/youtube/v3

3. **Apps Script制限**
   - https://developers.google.com/apps-script/guides/services/quotas

### 連絡先・リソース

- Google Cloud サポート
- Apps Script コミュニティフォーラム
- YouTube API サポートページ