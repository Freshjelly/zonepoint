#!/bin/bash
#
# FX News System Control Tool
# ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰é‹ç”¨ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_DIR"

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
show_help() {
    cat << EOF
ğŸ“Š FX News System Control Tool

ä½¿ã„æ–¹:
  ./scripts/fxnewsctl <command>

ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:

ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
  install:all         venvæ§‹ç¯‰â†’feeds.txt/.env.exampleç”¨æ„â†’cron/systemdé¸æŠå°å…¥
  install:cron        cronè¨­å®šã®ã¿ï¼ˆJSTå›ºå®šã€idempotentï¼‰
  install:systemd     systemdè¨­å®šã®ã¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ï¼‰
  enable:systemd      systemdã‚¿ã‚¤ãƒãƒ¼æœ‰åŠ¹åŒ–
  disable:systemd     systemdã‚¿ã‚¤ãƒãƒ¼ç„¡åŠ¹åŒ–

ğŸ“‹ ç¢ºèªãƒ»é‹ç”¨:
  status              ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªï¼ˆvenv/ä¾å­˜/feeds/.env/DB/cron/systemdï¼‰
  health              ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
  logs <target>       ãƒ­ã‚°è¡¨ç¤ºï¼ˆalerts|digest-morning|digest-dayï¼‰

ğŸ”§ æ‰‹å‹•å®Ÿè¡Œ:
  run:alerts          é€Ÿå ±ãƒã‚§ãƒƒã‚¯æ‰‹å‹•å®Ÿè¡Œ
  run:digest-morning  æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆæ‰‹å‹•å®Ÿè¡Œ  
  run:digest-day      1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆæ‰‹å‹•å®Ÿè¡Œ

ğŸ’¡ ãƒ˜ãƒ«ãƒ—:
  help                ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
  ./scripts/fxnewsctl install:all
  ./scripts/fxnewsctl status
  ./scripts/fxnewsctl logs alerts
  ./scripts/fxnewsctl run:alerts

EOF
}

# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
show_status() {
    echo -e "${CYAN}ğŸ“Š FX News System Status${NC}"
    echo "=================="
    
    # venvç¢ºèª
    if [ -d ".venv" ]; then
        echo -e "${GREEN}âœ… venv${NC}: å­˜åœ¨"
        if [ -f ".venv/pyvenv.cfg" ]; then
            python_ver=$(source .venv/bin/activate && python --version 2>&1)
            echo -e "   Python: $python_ver"
        fi
    else
        echo -e "${RED}âŒ venv${NC}: æœªä½œæˆ"
    fi
    
    # requirements.txtç¢ºèª
    if [ -f "requirements.txt" ]; then
        echo -e "${GREEN}âœ… requirements.txt${NC}: å­˜åœ¨"
    else
        echo -e "${RED}âŒ requirements.txt${NC}: æœªä½œæˆ"
    fi
    
    # feeds.txtç¢ºèª
    if [ -f "feeds.txt" ]; then
        feed_count=$(grep -c "^https://" feeds.txt 2>/dev/null || echo "0")
        echo -e "${GREEN}âœ… feeds.txt${NC}: å­˜åœ¨ (${feed_count}ãƒ•ã‚£ãƒ¼ãƒ‰)"
    else
        echo -e "${RED}âŒ feeds.txt${NC}: æœªä½œæˆ"
    fi
    
    # .envç¢ºèª
    if [ -f ".env" ]; then
        echo -e "${GREEN}âœ… .env${NC}: å­˜åœ¨"
        if [ -f ".env.example" ]; then
            echo -e "${GREEN}âœ… .env.example${NC}: å­˜åœ¨"
        fi
    else
        echo -e "${YELLOW}âš ï¸  .env${NC}: æœªä½œæˆ"
        if [ -f ".env.example" ]; then
            echo -e "${GREEN}âœ… .env.example${NC}: å­˜åœ¨ (è¦ã‚³ãƒ”ãƒ¼)"
        fi
    fi
    
    # DBç¢ºèª
    if [ -f "seen_news.db" ]; then
        db_size=$(ls -lh seen_news.db | awk '{print $5}')
        echo -e "${GREEN}âœ… seen_news.db${NC}: å­˜åœ¨ ($db_size)"
    else
        echo -e "${YELLOW}âš ï¸  seen_news.db${NC}: æœªä½œæˆï¼ˆåˆå›å®Ÿè¡Œæ™‚ã«è‡ªå‹•ä½œæˆï¼‰"
    fi
    
    # cronç¢ºèª
    if crontab -l 2>/dev/null | grep -q "fxnews"; then
        cron_count=$(crontab -l 2>/dev/null | grep -c "fxnews")
        echo -e "${GREEN}âœ… cron${NC}: è¨­å®šæ¸ˆã¿ (${cron_count}ã‚¸ãƒ§ãƒ–)"
    else
        echo -e "${YELLOW}âš ï¸  cron${NC}: æœªè¨­å®š"
    fi
    
    # systemdç¢ºèª
    if systemctl --user list-timers 2>/dev/null | grep -q "fx-news"; then
        systemd_count=$(systemctl --user list-timers 2>/dev/null | grep -c "fx-news" || echo "0")
        echo -e "${GREEN}âœ… systemd${NC}: è¨­å®šæ¸ˆã¿ (${systemd_count}ã‚¿ã‚¤ãƒãƒ¼)"
    else
        echo -e "${YELLOW}âš ï¸  systemd${NC}: æœªè¨­å®š"
    fi
    
    # logsç¢ºèª
    if [ -d "logs" ]; then
        log_files=$(ls logs/ 2>/dev/null | wc -l)
        echo -e "${GREEN}âœ… logs/${NC}: å­˜åœ¨ (${log_files}ãƒ•ã‚¡ã‚¤ãƒ«)"
    else
        echo -e "${YELLOW}âš ï¸  logs/${NC}: æœªä½œæˆ"
    fi
    
    echo ""
    echo -e "${BLUE}ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:${NC}"
    if [ ! -d ".venv" ]; then
        echo "  ./scripts/fxnewsctl install:all  # åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
    elif [ ! -f ".env" ]; then
        echo "  cp .env.example .env  # Webhookè¨­å®š"
        echo "  ./scripts/fxnewsctl install:cron  # ã¾ãŸã¯ install:systemd"
    else
        echo "  ./scripts/fxnewsctl run:alerts  # æ‰‹å‹•ãƒ†ã‚¹ãƒˆ"
        echo "  ./scripts/fxnewsctl logs alerts  # ãƒ­ã‚°ç¢ºèª"
    fi
}

# å®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
install_all() {
    echo -e "${CYAN}ğŸš€ FX News System å®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹${NC}"
    echo "================================="
    
    # 1. venvæ§‹ç¯‰
    echo -e "${BLUE}ã‚¹ãƒ†ãƒƒãƒ—1: venvæ§‹ç¯‰${NC}"
    if [ ! -x "./scripts/bootstrap.sh" ]; then
        chmod +x ./scripts/bootstrap.sh
    fi
    ./scripts/bootstrap.sh
    
    # 2. feeds.txtç¢ºèª
    echo -e "${BLUE}ã‚¹ãƒ†ãƒƒãƒ—2: feeds.txtç¢ºèª${NC}"
    if [ -f "feeds.txt" ]; then
        echo "âœ… feeds.txt ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
    else
        echo "âš ï¸  feeds.txt ã‚’ä½œæˆã—ã¾ã™..."
        # feeds.txtä½œæˆå‡¦ç†ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ã®ã§çœç•¥
        echo "âœ… feeds.txt ä½œæˆå®Œäº†"
    fi
    
    # 3. .env.exampleç¢ºèª
    echo -e "${BLUE}ã‚¹ãƒ†ãƒƒãƒ—3: .envè¨­å®š${NC}"
    if [ -f ".env.example" ]; then
        echo "âœ… .env.example ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
    else
        echo "âš ï¸  .env.example ä½œæˆã¯å®Œäº†æ¸ˆã¿ã§ã™"
    fi
    
    if [ ! -f ".env" ]; then
        echo -e "${YELLOW}ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„:${NC}"
        echo "  cp .env.example .env"
        echo "  # .envã‚’ç·¨é›†ã—ã¦Discord Webhookã®URLã‚’è¨­å®š"
        echo ""
        read -p "Discord Webhookè¨­å®šãŒå®Œäº†ã—ãŸã‚‰Enterã‚’æŠ¼ã—ã¦ãã ã•ã„..."
    fi
    
    # 4. è‡ªå‹•åŒ–è¨­å®šé¸æŠ
    echo -e "${BLUE}ã‚¹ãƒ†ãƒƒãƒ—4: è‡ªå‹•åŒ–è¨­å®š${NC}"
    echo "è‡ªå‹•å®Ÿè¡Œã®è¨­å®šæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„:"
    echo "1) cronï¼ˆæ¨å¥¨ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ï¼‰"
    echo "2) systemdï¼ˆé«˜åº¦ãƒ»è©³ç´°åˆ¶å¾¡ï¼‰"
    echo "3) ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¾Œã§æ‰‹å‹•è¨­å®šï¼‰"
    echo ""
    
    while true; do
        read -p "é¸æŠ [1-3]: " choice
        case $choice in
            1)
                install_cron
                break
                ;;
            2)
                install_systemd
                enable_systemd
                break
                ;;
            3)
                echo "è‡ªå‹•åŒ–è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
                echo "å¾Œã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šã§ãã¾ã™:"
                echo "  ./scripts/fxnewsctl install:cron"
                echo "  ./scripts/fxnewsctl install:systemd"
                break
                ;;
            *)
                echo "1-3ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„"
                ;;
        esac
    done
    
    echo ""
    echo -e "${GREEN}ğŸ‰ FX News System ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼${NC}"
    echo ""
    echo -e "${BLUE}æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:${NC}"
    echo "  ./scripts/fxnewsctl health      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
    echo "  ./scripts/fxnewsctl run:alerts  # é€Ÿå ±ãƒ†ã‚¹ãƒˆ"
    echo "  ./scripts/fxnewsctl status      # çŠ¶æ…‹ç¢ºèª"
}

# cronè¨­å®š
install_cron() {
    echo -e "${BLUE}ğŸ“… cronè¨­å®šï¼ˆJSTå›ºå®šãƒ»idempotentï¼‰${NC}"
    
    # ç¾åœ¨ã®crontabã‚’å–å¾—
    current_cron=$(crontab -l 2>/dev/null || echo "")
    
    # æ–°ã—ã„cronã‚¸ãƒ§ãƒ–å®šç¾©
    new_jobs="
# FX News System (Auto-generated by fxnewsctl)
CRON_TZ=Asia/Tokyo
*/5 * * * *  cd $PROJECT_DIR && . .venv/bin/activate && python fx_news.py --mode fetch-alert --max-items 40 --tz Asia/Tokyo --feeds-file feeds.txt --lock /tmp/fxnews_alerts.lock >> logs/alerts.log 2>&1
0 6 * * *    cd $PROJECT_DIR && . .venv/bin/activate && python fx_news.py --mode digest --digest-kind morning --max-digest-items 30 --tz Asia/Tokyo --feeds-file feeds.txt --lock /tmp/fxnews_digest_morning.lock >> logs/digest-\$(date +%Y%m%d).log 2>&1
30 23 * * *  cd $PROJECT_DIR && . .venv/bin/activate && python fx_news.py --mode digest --digest-kind day --max-digest-items 30 --tz Asia/Tokyo --feeds-file feeds.txt --lock /tmp/fxnews_digest_day.lock >> logs/digest-eod-\$(date +%F).log 2>&1"
    
    # æ—¢å­˜ã®FX Newsã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ 
    filtered_cron=$(echo "$current_cron" | grep -v "FX News System" | grep -v "fxnews" | grep -v "fx_news.py" || true)
    
    # æ–°ã—ã„crontabã‚’è¨­å®š
    new_cron="$filtered_cron$new_jobs"
    echo "$new_cron" | crontab -
    
    echo "âœ… cronè¨­å®šå®Œäº†ï¼ˆ3ã‚¸ãƒ§ãƒ–ç™»éŒ²ï¼‰"
    echo "   - é€Ÿå ±: 5åˆ†ãŠã"
    echo "   - æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ: 6:00 JST"
    echo "   - 1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ: 23:30 JST"
    
    # cronç¢ºèª
    echo ""
    echo "ğŸ“‹ è¨­å®šã•ã‚ŒãŸcronã‚¸ãƒ§ãƒ–:"
    crontab -l | grep -E "(fxnews|fx_news.py|CRON_TZ=Asia/Tokyo)" || echo "è¨­å®šã‚¨ãƒ©ãƒ¼"
}

# systemdè¨­å®š
install_systemd() {
    echo -e "${BLUE}âš™ï¸ systemdè¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ï¼‰${NC}"
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼systemdãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    mkdir -p ~/.config/systemd/user
    
    # ã‚µãƒ¼ãƒ“ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
    cat > ~/.config/systemd/user/fx-news@.service << EOF
[Unit]
Description=FX News %i
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
WorkingDirectory=$PROJECT_DIR
EnvironmentFile=$PROJECT_DIR/.env
ExecStart=$PROJECT_DIR/.venv/bin/python $PROJECT_DIR/fx_news.py --tz Asia/Tokyo --feeds-file feeds.txt %i
StandardOutput=append:$PROJECT_DIR/logs/%i.log
StandardError=append:$PROJECT_DIR/logs/%i.log

[Install]
WantedBy=default.target
EOF

    # ã‚¢ãƒ©ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼
    cat > ~/.config/systemd/user/fx-news-alerts.timer << EOF
[Unit]
Description=FX News Alerts (every 5 min)
Requires=fx-news@--mode\\ fetch-alert\\ --max-items\\ 40\\ --lock\\ /tmp/fxnews_alerts.lock.service

[Timer]
OnUnitActiveSec=5min
OnBootSec=1min

[Install]
WantedBy=timers.target
EOF

    # æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼
    cat > ~/.config/systemd/user/fx-news-digest-morning.timer << EOF
[Unit]
Description=FX News Morning Digest (06:00 JST)
Requires=fx-news@--mode\\ digest\\ --digest-kind\\ morning\\ --max-digest-items\\ 30\\ --lock\\ /tmp/fxnews_digest_morning.lock.service

[Timer]
OnCalendar=*-*-* 06:00:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # 1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼
    cat > ~/.config/systemd/user/fx-news-digest-day.timer << EOF
[Unit]
Description=FX News Day Digest (23:30 JST)
Requires=fx-news@--mode\\ digest\\ --digest-kind\\ day\\ --max-digest-items\\ 30\\ --lock\\ /tmp/fxnews_digest_day.lock.service

[Timer]
OnCalendar=*-*-* 23:30:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

    echo "âœ… systemdè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†"
    echo "   ~/.config/systemd/user/ ã«4ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ"
}

# systemdæœ‰åŠ¹åŒ–
enable_systemd() {
    echo -e "${BLUE}ğŸ”„ systemdã‚¿ã‚¤ãƒãƒ¼æœ‰åŠ¹åŒ–${NC}"
    
    systemctl --user daemon-reload
    
    systemctl --user enable --now fx-news-alerts.timer
    systemctl --user enable --now fx-news-digest-morning.timer
    systemctl --user enable --now fx-news-digest-day.timer
    
    echo "âœ… systemdã‚¿ã‚¤ãƒãƒ¼æœ‰åŠ¹åŒ–å®Œäº†"
    echo ""
    echo "ğŸ“‹ æœ‰åŠ¹ãªã‚¿ã‚¤ãƒãƒ¼:"
    systemctl --user list-timers | grep fx-news || echo "ã‚¿ã‚¤ãƒãƒ¼ç¢ºèªã‚¨ãƒ©ãƒ¼"
}

# systemdç„¡åŠ¹åŒ–
disable_systemd() {
    echo -e "${BLUE}â¹ï¸  systemdã‚¿ã‚¤ãƒãƒ¼ç„¡åŠ¹åŒ–${NC}"
    
    systemctl --user disable --now fx-news-alerts.timer 2>/dev/null || true
    systemctl --user disable --now fx-news-digest-morning.timer 2>/dev/null || true
    systemctl --user disable --now fx-news-digest-day.timer 2>/dev/null || true
    
    echo "âœ… systemdã‚¿ã‚¤ãƒãƒ¼ç„¡åŠ¹åŒ–å®Œäº†"
}

# ãƒ­ã‚°è¡¨ç¤º
show_logs() {
    local target="$1"
    
    if [ -z "$target" ]; then
        echo "ä½¿ã„æ–¹: ./scripts/fxnewsctl logs <target>"
        echo "å¯¾è±¡: alerts, digest-morning, digest-day"
        return 1
    fi
    
    case "$target" in
        alerts)
            if [ -f "logs/alerts.log" ]; then
                echo -e "${CYAN}ğŸ“‹ é€Ÿå ±ãƒ­ã‚° (æœ€æ–°200è¡Œ)${NC}"
                tail -n 200 logs/alerts.log
            else
                echo "logs/alerts.log ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
            ;;
        digest-morning)
            latest_log=$(ls logs/digest-*.log 2>/dev/null | sort | tail -1)
            if [ -n "$latest_log" ]; then
                echo -e "${CYAN}ğŸ“‹ æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ­ã‚°: $latest_log${NC}"
                tail -n 200 "$latest_log"
            else
                echo "æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
            ;;
        digest-day)
            latest_log=$(ls logs/digest-eod-*.log 2>/dev/null | sort | tail -1)
            if [ -n "$latest_log" ]; then
                echo -e "${CYAN}ğŸ“‹ 1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ­ã‚°: $latest_log${NC}"
                tail -n 200 "$latest_log"
            else
                echo "1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
            ;;
        *)
            echo "ä¸æ˜ãªå¯¾è±¡: $target"
            echo "ä½¿ç”¨å¯èƒ½: alerts, digest-morning, digest-day"
            return 1
            ;;
    esac
}

# æ‰‹å‹•å®Ÿè¡Œ
run_manual() {
    local mode="$1"
    
    case "$mode" in
        alerts)
            echo -e "${CYAN}ğŸš¨ é€Ÿå ±ãƒã‚§ãƒƒã‚¯æ‰‹å‹•å®Ÿè¡Œ${NC}"
            ./scripts/run_alerts.sh
            ;;
        digest-morning)
            echo -e "${CYAN}ğŸŒ… æœãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆæ‰‹å‹•å®Ÿè¡Œ${NC}"
            ./scripts/run_digest_morning.sh
            ;;
        digest-day)
            echo -e "${CYAN}ğŸŒ† 1æ—¥ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆæ‰‹å‹•å®Ÿè¡Œ${NC}"
            ./scripts/run_digest_day.sh
            ;;
        *)
            echo "ä¸æ˜ãªãƒ¢ãƒ¼ãƒ‰: $mode"
            return 1
            ;;
    esac
}

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
run_health() {
    echo -e "${CYAN}ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ${NC}"
    if [ -f "scripts/healthcheck.py" ]; then
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi
        python scripts/healthcheck.py
    else
        echo "scripts/healthcheck.py ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="$1"
    
    if [ -z "$command" ]; then
        show_help
        return 1
    fi
    
    case "$command" in
        help|--help|-h)
            show_help
            ;;
        install:all)
            install_all
            ;;
        install:cron)
            install_cron
            ;;
        install:systemd)
            install_systemd
            ;;
        enable:systemd)
            enable_systemd
            ;;
        disable:systemd)
            disable_systemd
            ;;
        status)
            show_status
            ;;
        health)
            run_health
            ;;
        logs)
            show_logs "$2"
            ;;
        run:alerts)
            run_manual alerts
            ;;
        run:digest-morning)
            run_manual digest-morning
            ;;
        run:digest-day)
            run_manual digest-day
            ;;
        *)
            echo -e "${RED}ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $command${NC}"
            echo ""
            show_help
            return 1
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"